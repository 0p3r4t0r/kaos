#!/usr/bin/env bash

# ------------------------------------------------------------------------------
# SETTINGS
# ------------------------------------------------------------------------------

set -e


# ------------------------------------------------------------------------------
# HELPERS
# ------------------------------------------------------------------------------

function _header {
    header=$1

    echo "-----------------------------------------------------------"
    echo "$header"
    echo -e "-----------------------------------------------------------\n"
}

function _subheader {
    subheader=$1
    length=${#subheader}

    echo "$subheader"
    printf -- "-%.0s" $(seq $length)
    echo "" # newline
}

function _confirm {
    prompt=$1

    while true; do
        read -p "$prompt (y/n): " uservar

        case "$uservar" in
            y|Y|yes|Yes|YES)
                return 0
                ;;

            n|N|no|No|NO)
                return 1
                ;;
        esac
    done
}


# ------------------------------------------------------------------------------
# MAIN
# ------------------------------------------------------------------------------

# Create dist dir
# ---------------
dist="$(pwd)/dist/"
[[ ! -d "$dist" ]] && mkdir "$dist"


# Update submodules
# -----------------
_header "UPDATE: SUBMODULES"

echo -n "Updating submodules from remotes..."
git submodule update --init --recursive --quiet
echo -e "done\n\n"

_subheader "Submodule Status (check hashes)"
git submodule status
echo -e "\n"

_subheader "Submodule Summary"
git submodule summary

_confirm "Proceed w/ build?"
echo -e "\n"


# Build Website
# -------------
_header "BUILD: KAOS WEBSITE"
cd src/kaos-website

if [[ ! -d node_modules ]]; then
    _subheader "No node_modules/ detected. Running \`npm ci\`."
    npm ci
fi

_subheader "Running \`npm build\`."
npm run build

echo -n "Copying dist folder contents..."
cp -r dist/* "$dist"
echo "Done"

echo -e "\n"
cd -


# Build Canvas
# ------------
_header "BUILD: KAOS CANVAS"
cd src/kaos-canvas

if [[ ! -d node_modules ]]; then
    _subheader "No node_modules/ detected. Running \`npm ci\`."
    npm ci
fi

_subheader "Running \`npm build\`."
npm run build

echo -n "Copying index.js..."
cp -r dist/index.js "$dist/canvas.js"
echo "Done"

echo -e "\n"
cd -
