#!/usr/bin/env bash

# ------------------------------------------------------------------------------
# SETTINGS
# ------------------------------------------------------------------------------

set -e


# ------------------------------------------------------------------------------
# HELPERS
# ------------------------------------------------------------------------------

function _header {
    header=$1

    echo "-----------------------------------------------------------"
    echo "$header"
    echo -e "-----------------------------------------------------------\n"
}

function _subheader {
    subheader=$1
    length=${#subheader}

    echo "$subheader"
    printf -- "-%.0s" $(seq $length)
    echo "" # newline
}

function _confirm {
    prompt=$1

    while true; do
        read -p "$prompt (y/n): " uservar

        case "$uservar" in
            y|Y|yes|Yes|YES)
                return 0
                ;;

            n|N|no|No|NO)
                return 1
                ;;
        esac
    done
}


# ------------------------------------------------------------------------------
# MAIN
# ------------------------------------------------------------------------------

# Create/clean dist dir
# ---------------
dist="$(pwd)/dist"
[[ ! -d "$dist" ]] && mkdir -p "$dist"
rm -rf $dist/*


echo -n "Updating submodules from remotes..."
git submodule update --init --remote --merge --quiet
echo -e "done\n\n"


# Build Website
# -------------
_header "BUILD: KAOS WEBSITE"
cd src/kaos-website

if [[ ! -d node_modules ]]; then
    _subheader "No node_modules/ detected. Installing dependencies."
    [[ -f package-lock.json ]] && npm ci || npm install
fi

_subheader "Running \`npm build\`."
npm run build

echo -n "Copying dist folder contents..."
cp -r dist "$dist/public"
echo "Done"

echo -e "\n"
cd -


# Build Canvas
# ------------
_header "BUILD: KAOS CANVAS"
cd src/kaos-canvas

if [[ ! -d node_modules ]]; then
    _subheader "No node_modules/ detected. Installing dependencies."
    [[ -f package-lock.json ]] && npm ci || npm install
fi

_subheader "Running \`npm build\`."
npm run build

echo -n "Copying index.js..."
cp -r dist/index.js "$dist/public/canvas.js"
echo "Done"

echo -e "\n"
cd -


# Update Server
# -------------
_header "UPDATE: KAOS SERVER"

if [[ ! -d node_modules ]]; then
    _subheader "No node_modules/ detected. Installing dependencies."
    [[ -f package-lock.json ]] && npm ci || npm install
fi

echo -n "Copying index.js..."
cp -r src/kaos-server/index.js "$dist/server.js"
echo "Done"

echo -e "\n"
cd -
